name: Publish Documentation

on:
  push:
    tags:
      - "v*" # Triggers on tags like v1.0, v2.1.3, etc.

permissions:
  contents: write # REQUIRED: Allows the bot to write to the gh-pages branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # REQUIRED: Fetch all history for mike to manage branches

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Dependencies
        run: |
          pip install mkdocs-material mkdocs-static-i18n mike
          # Add any other plugins from your mkdocs.yml here

      - name: Configure Git User
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract Version Name
        id: extract_version
        shell: bash
        run: |
          # Takes 'refs/tags/v1.2.0' and converts it to '1.2'
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)

          echo "version=$MAJOR_MINOR" >> $GITHUB_OUTPUT
          echo "Deploying version: $MAJOR_MINOR"

      - name: Deploy Version with Mike
        run: |
          # 1. Deploy the new version and update 'latest' alias
          mike deploy ${{ steps.extract_version.outputs.version }} latest --update-aliases --push

          # 2. Set the default redirect (Fixes Root 404)
          # This creates an index.html at the root that redirects to 'latest'
          mike set-default latest --push

      - name: Ensure .nojekyll exists
        run: |
          # 3. Checkout gh-pages to add .nojekyll (Fixes Broken Assets/404 on CSS)
          # GitHub Pages (Jekyll) ignores folders starting with '_' by default.
          # MkDocs uses '_static', so we must disable Jekyll.

          git fetch origin gh-pages
          git checkout gh-pages

          if [ ! -f .nojekyll ]; then
            echo "Creating .nojekyll file..."
            touch .nojekyll
            git add .nojekyll
            git commit -m "Add .nojekyll to fix asset loading"
            git push origin gh-pages
          else
            echo ".nojekyll already exists."
          fi
